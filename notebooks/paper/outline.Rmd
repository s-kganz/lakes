---
title: "Modeling Maximum Depth for all Lakes in the United States"
author:
- Keenan Ganz
- Max Glines
- Kevin Rose
output:
  bookdown::word_document2:
    toc: false
    number_sections: yes
    reference: C:\\users\\ganzk\\desktop\\lakes\\notebooks\\style-ref.docx
bibliography: C:\\users\\ganzk\\desktop\\lakes\\notebooks\\bibliography.bib
csl: C:\\users\\ganzk\\desktop\\lakes\\notebooks\\american-institute-of-physics.csl
nocite: |
  @oliverPredictionLakeDepth2016, @heathcotePredictingBathymetricFeatures2015 |
  @sobekPredictingDepthVolume2011, @hollisterPredictingMaximumLake2011a |
  @duPracticalSplitWindowAlgorithm2015, @vanhellemontAutomatedWaterSurface2020
---

```{r setup, echo=F, message=F}
knitr::opts_knit$set(root.dir = normalizePath("../.."))
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```
```{r libraries}
library(tidyverse)
library(knitr)
```


# Introduction
A summary of prior models of maximum lake depth is given in Table \@ref(tab:previousModelTable).

# Methods
## Lake Data Sources
Lake polygons, depth measurements, and other lake attributes were derived from LAGOS-US LOCUS and DEPTH modules[@cheruvelilLAGOSUSLOCUSV12021; @stachelekLAGOSUSDEPTHV12021]. Candidate predictor variables were identified from the four tables included in the LOCUS module. Polygon attributes, including area, perimeter, shoreline development index, maximum distance from shoreline, and oriented bounding box length-width ratio, were calculated within QGIS[@qgisdevelopmentteamQGISGeographicInformation2021].

## Terrain Analysis
Terrain metrics were derived from the Shuttle Radar Topography Mission 30m digital elevation model within 200m buffer zones around each lake polygon[@farrShuttleRadarTopography2007]. Although other digital elevation models offer finer resolution within the US, SRTM is available worldwide such that the depth model described here may be applied outside of the US.

All terrain analysis was carried out with Google Earth Engine (GEE)[@gorelickGoogleEarthEngine2017a]. Predictor variables from the four models summarized in  were replicated as closely as possible within the GEE environment. Additional predictors, including buffer elevation, buffer slope, terrain roughness index, horizontal curvature, and kernel-based metrics were included to fully describe the topography of lake buffer zones[@safanelliTerrainAnalysisGoogle2020]. Each metric was calculated for all SRTM pixels within a buffer zone and summarized as the minimum, maximum, mean, and standard deviation.

Kernel-based metrics applied summary statistics to all pixels within a given distance of a central pixel. This captures terrain features at a variety of scales. Terrain relief was calculated as the maximum difference between the central pixel and all other pixels in the kernel. Terrain deviation was calculated as the difference between the central pixel and the mean elevation of all pixels in the kernel, normalized to the standard deviation of all pixels in the kernel.

## Spatial Autocorrelation
After Oliver et al. (2016), spatial autocorrelation was assumed at the HUC04 scale. Additional predictors were generated by summarizing terrain metrics, polygon attributes, and lake depth within each HUC04 unit.

## Lake Surface Temperature
Lake morphology may be predicted through its relationship with lake heat budget[@birgeHeatBudgetsAmerican1915]. When lake waters are well mixed, water temperature is consistent throughout the water column. Under this regime, deep lakes require a larger energy input to illicit a surface temperature change than shallower lakes. Lake surface temperature during turnover may therefore be indicative of maximum lake depth. A pilot study found that EOS ASTER nighttime water surface temperature explained roughly a third of the variance in maximum lake depth [@beckerInfluenceLakeMorphology2005]. 

Expanding this workflow to all lakes in the United States is complicated by incomplete EOS ASTER nighttime ocverage over the contiguous US, atmospheric effects, cloudy imagery, and regional climate variation. It was hypothesized that lake surface temperature is most strongly correlated with regional climate. Therefore, deviation from a regional median land surface temperature would be indicative of lake heat budget.

Within GEE, daytime 30m Landsat 8 Collection 1 Tier 1 imagery from 2013 to present was used as a source of high-resolution lake surface temperature[@usgeologicalsurveyLandsatCollectionTier]. Cloudy pixels were masked with the quality assurance band of each image. Radiance in bands 10 and 11 was converted to water surface temperature according to the procedure given in Vanhellmont (2020)[@vanhellemontAutomatedWaterSurface2020]. First, radiance ($L$) was converted to brightness temperature ($BT$) according to Equation \@ref(eq:brightnessTemp) and constants listed in Table \@ref(tab:btCoefTable).

Brightness temperatures from bands B10 and B11 are then combined and atmospherically corrected according to constants given in Du et al. (2015) (Equation \@ref(eq:btCorrection); Table \@ref(tab:atmosphericCorrectionTable)). In Equation \@ref(eq:btCorrection), $\bar{\epsilon}$ and $\Delta\epsilon$ refer to the average and difference between the two $\epsilon_{water}$ values given in Table \@ref(tab:btCoefTable).

Monthly median Landsat surface temperature was calculated at the center of each lake in March-May and September-November to capture periods where lake turnover was most likely.

Monthly median 1km MODIS surface temperature from 2017 was used as representative of local climate[@henglLongtermMODISLST2018]. A focal median filter was applied to the MODIS imagery with a 3-pixel radius circular kernel, effectively increasing the length scale of median surface temperature to 7km. The difference between lake Landsat surface temperature and MODIS regional surface temperature was calculated for each month and included as a separate candidate predictor of maximum lake depth.

## Modeling Workflow
### Model Evaluation
Comparison of existing lake depth models has been impeded by inconsistent source data and small study areas. All models in Table 1 were replicated on the LAGOS-US DEPTH data module. Oliver et al. excluded lakes larger than 1000ha from modeling since depth is known for over 80% of these lakes. A similar proportion (72.5%) of large lakes larger than 1000ha had known maximum depth in the LAGOS-US DEPTH module, so these were excluded from modeling (Figure \@ref(fig:depthObsByArea)). Model performance was evaluated on a stratified sample of 10% of lake depth measurements held out during model training. Evaluation metrics included $R^2$, root mean square error (RMSE), and mean absolute percent error (MAPE).

### Random Forest Model
Random forest modeling[@breimanRandomForests2001; @wrightRangerFastImplementation2017] was used for its robustness to multicollinearity and ability to capture nonlinear relationships. Feature selection was performed with the R package `Boruta` to screen out ineffective predictors. The Boruta algorithm proceeds by generating a random forest model for a regression problem and iteratively comparing the importance of a candidate predictor with random noise[@kursaFeatureSelectionBoruta2010]. Candidate predictors that outperformed random noise were retained in the random forest model and all others were discarded.

# Results
# Discussion
\newpage
<!-- Tables -->
```{r previousModelTable}
tibble(
  "Citation"=c("Oliver et al. (2016)", "Hollister et al. (2011)", "Heathcote et al. (2015)", "Sobek (2011)", "Becker and Daw (2005)"),
  "Region"=c("Northeastern US", "Eastern US", "Southern Quebec", "Sweden", "Wisconsin, US"),
  "Model"=c("Linear mixed effects", "Linear regression", "Linear regression", "Linear regression", "Linear regression"),
  "Predictors"=c("Lake area, shoreline development index, buffer slope, watershed to lake area ratio", "Buffer slope", "Buffer elevation change", "Lake area, perimeter, buffer slope", "Nighttime water surface temperature"),
  "Maximum Depth $R^2$"=c(0.29, "0.48-0.67", 0.52, 0.36, 0.36),
  "RMSE"=c("7.1m", "5.09-5.95m", "0.245 $\\log_{10}$m", "Not reported", "Not reported")
) %>%
  knitr::kable(caption="Summary of existing models of maximum lake depth, using local topography and regional characteristics.")
```

```{r btCoefTable}
tibble(
  "Band"=c("B10", "B11"),
  "Wavelength ($\\mu$m)" = c(10.9, 12.0),
  "Bandwidth ($\\mu$m)" = c("10.6 - 11.2", "11.5 - 12.5"),
  "$\\epsilon_{water}$" = c(0.9926, 0.9877),
  "$K_1$ (Wm$^{-2}$sr$^{-1}\\mu$m)"=c(774.8853, 480.8883),
  "$K_2$ (K)" = c(1321.0789, 1201.1442)
) %>%
  knitr::kable(caption="Constants used in the calculation of brightness temperature from Landsat radiance. Reproduced from Vanhellmont (2020).")
```

```{r atmosphericCorrectionTable}
tibble(
  "$b_0$"=c(-0.41165),
  "$b_1$"=c( 1.00522),
  "$b_2$"=c( 0.14543),
  "$b_3$"=c(-0.27297),
  "$b_4$"=c( 4.06655),
  "$b_5$"=c(-6.92512),
  "$b_6$"=c(-18.27461),
  "$b_7$"=c( 0.24468),
) %>%
  knitr::kable(caption="Values of constants used to apply atmospheric correction to Landsat brightness temperature from Du et al. (2015)", align=rep("l", 7))
```
\newpage
<!-- Equations -->
\begin{equation}
\begin{aligned}
BT &= \frac{K_2}{\ln{\frac{K_1}{L} + 1}}
\end{aligned}
(\#eq:brightnessTemp)
\end{equation}

\begin{equation}
\begin{aligned}
LST &= 
  b_0 + 
  (b_1 + b_2\frac{1-\bar{\epsilon}}{\bar{\epsilon}} +  b_3\frac{\Delta\epsilon}{\bar{\epsilon}^2})\frac{BT_{10} + BT_{11}}{2} + \\
  (b_4 + b_5\frac{1-\bar{\epsilon}}{\bar{\epsilon}} +  b_6\frac{\Delta\epsilon}{\bar{\epsilon}^2})\frac{BT_{10} -  BT_{11}}{2} + \\
  b_7(BT_{10} - BT_{11})^2
\end{aligned}
(\#eq:btCorrection)
\end{equation}

\newpage

<!-- Figures -->
```{r depthObsByArea, fig.cap="Proportion of lakes in LAGOS US with known maximum depth. Vertical dotted line: maximum lake area included in lake depth modeling."}
knitr::include_graphics(normalizePath("notebooks/paper/figures/depth_proportion.png"))
```

\newpage

# References

<!-- # Introduction -->
<!--  - Summary of prior models in the literature -->
<!-- # Methods -->
<!-- ## Data Sources -->
<!--  - LAGOS US, LAGOS NE, NLA -->
<!-- ## Terrain Analysis -->
<!--  - 30m SRTM DEM -->
<!--  - Elevation, Slope, Curvature -->
<!--  - Kernel-based metrics -->
<!-- ## Modeling Workflow -->
<!--   - Feature selection -->
<!--   - Monte Carlo test for significance -->
<!-- ## Lake volume estimation -->
<!--   - cone approximation -->
<!-- # Results -->
<!-- # Discussion -->

<!-- Key figures and tables -->
<!-- Table 1: Summary of previous modeling studies -->
<!--   Ref, equation, location, n, R2, RMSE -->
<!-- Table 2: Summary of candidate predictors and where they come from -->
<!-- Table 3: Summary of modeling results -->
<!--   Ref, R2 (RMSE) for NLA, LAGOS NE, LAGOS US -->

<!-- Figure 2: Diagram of why curvature improves depth estimate -->
<!-- Figure 1: 1:1 plots for each of the tested models (training & validation) -->