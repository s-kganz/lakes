---
title: "Research Update: 25 October 2021"
author:
- Keenan Ganz
output:
  pdf_document:
    extra_dependencies: ["booktabs"]
bibliography: bibliography.bib
csl: american-institute-of-physics.csl
nocite: |
  @oliverPredictionLakeDepth2016, @heathcotePredictingBathymetricFeatures2015 |
  @sobekPredictingDepthVolume2011
---

```{r setup, echo=F, message=F}
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```
```{r libraries}
library(igraph)
library(sf)
library(tidyverse)
library(caret)
library(randomForest)
library(ggridges)
library(latex2exp)
library(mgcv)
```

This notebook summarizes the work I have done on the lake depth modeling project so far.

# Literature Review

There are two main lake depth modeling strategies in the literature that differ in their predictors. In the first, characteristics of the terrain in the lake basin are extended below the water line to estimate maximum water depth. In the second, other characteristics of a lake - including shoreline geometry, watershed size, and position in the drainage network - are correlated with existing maximum depth measurements.

Both of these strategies are represented in R packages as well. `lakemorpho` implements the basin morphology approach while `LAGOSNE` implements the correlative approach alongside an interface to other lake data[@hollisterLakemorphoCalculatingLake2017; @stachelekLAGOSNEInterfaceLake2019]. 

In its simplest form, the basin morphology modeling approach computes the median slope in a lake basin and assumes that lake bathymetry has a similar shape. Estimated lake depth, denoted $\hat{Z}$, is calculated as

\begin{align}
\hat{Z} = D \times S_1
\end{align}

where $D$ is the maximum distance from shoreline and $S_1$ is the median slope within the lake basin[@hollisterPredictingMaximumLake2011a]. Few published studies opt for one depth modeling technique or the other. Several topographic and other variables are combined to produce the best model for the region under study. Citations, model selection, predictors, and model performance for studies published within the last decade are shown in Table 1.

There is some variation in how the lake basin polygon is determined among published literature. Intuitively, larger lakes probably have larger basins. So, a larger buffer around a lake polygon is necessary to capture information on the surrounding topography. At the same time, too large a buffer may extend beyond the lake basin and add superfluous topography to the slope calculation. Several basin calculation methods are present in the literature, including a constant buffer distance, a buffer distance dependent on lake size, and buffers incorporating drainage information.

\newpage
```{r previous-model-table}
tibble(
  "Citation"=c("Oliver et al. (2016)", "Hollister et al. (2011)", "Heathcote et al. (2015)", "Sobek (2011)"),
  "Region"=c("Northeastern United States", "NHD HUC 01 and 02", "Southern Quebec, Canada", "Sweden"),
  "Model"=c("Mixed effects (regional and observational)", "$\\hat{Z} \\approx D \\cdot S_{median}$", "Log-transformed linear regression", "Log-transformed linear regression and partial least squares regression"),
  "Most Important Predictor"=c("Not reported", "Median slope", "Elevation change 25m from lake", "Lake area, perimeter, median slope"),
  "Maximum Depth $R^2$"=c(0.29, "0.48-0.67", 0.52, 0.36),
  "RMSE"=c("7.1m", "5.09-5.95m", "0.245 $\\log_{10}$m", "Not reported")
) %>%
  knitr::kable(caption="Summary of existing models of maximum lake depth, using local topography and regional characteristics. $\\hat{Z}$: maximum lake depth; $D$: maximum distance from shore in lake; $S_{median}$: median slope in lake catchment.")
```

Direct comparison of published models is impeded by inconsistent study region data sources. The variability of the underlying lake data clearly impacts the predictive power of the resulting model. The two studies with the highest reported $R^2$ also had the most restrictive study region. However, some patterns are evident. Although topographic information alone accounts for <50% of the variability in maximum depth, topographic variables are represented in all four models in Table 1. Other lake characteristics have some predictive power, but terrain metrics are an essential part of lake depth modeling.

The goals of this project have been to recreate the above models using a common dataset, explore the predictive power of other terrain metrics, consider the predictive power of the geologic context of a lake basin, and to compare the effect of buffer procedure on predicted lake depth.

# Methods
## Data Sources
Surveyed maximum lake depths and lake polygons were acquired from the EPA National Lakes Assessment, carried out in 2007 and 2012[@usepa2012NationalLakes]. For lakes that were sampled in both campaigns, only the most recent survey data was retained. Topographic data was computed from the Shuttle Radar Topography Mission 30m digital elevation model [@farrShuttleRadarTopography2007]. Geologic units were identified from the state geologic map compilation[@hortonStateGeologicMap2017].

## Spatial Processing
Spatial operations were carried out in QGIS. Large rasters were processed on the cloud GIS platform Google Earth Engine (GEE)[@gorelickGoogleEarthEngine2017a]. The general workflow was as follows:

1. Compute buffer regions around lake polygons.
2. Upload buffer regions to GEE.
3. Compute zonal statistics for a given raster dataset within each buffer region.
4. Perform statistical analysis in R[@rcoreteamLanguageEnvironmentStatistical2021].

Specific processing steps are described in accompanying notebooks.

# Results

```{r read-data}
gee_hollister <- read_csv("data_out/nla_hollister_gee.csv")
gee_terrain <- read_csv("data_out/nla_terrain_gee.csv")
nla_elev <- read_csv("data_in/gee/nla_lake_elev.csv")

# join elevation data to the terrain data - calculate the necessary
# predictors for all the lms
gee_terrain <- nla_elev %>%
  rename(lake_elevation=elevation) %>%
  inner_join(gee_terrain, by="NLAID") %>%
  mutate(logarea = log(lakearea_m2),
         log_elev_change = log10(elev200_median - lake_elevation),
         log_maxdepth = log10(maxdepth),
         linear_term = slope200_median * dist_pole) %>%
  drop_na()

gee_hollister <- gee_hollister %>%
  mutate(linear_term = slope_median * dist_pole,
         quad_term   = vcurv_max * dist_pole^2 * 0.5)
```

## Existing Model Comparison
The four models in Table 1 were recreated as closely as possible for the present data sources. Some parameters, such as length scale or buffer size, were adjusted to account for the precision of existing data.

```{r make-models}
# Hollister 2011 - use their buffers and take median slope
hollister_lm <- gee_terrain %>%
  lm(maxdepth ~ linear_term, data=.)

# Sobek 2011 - log area + max slope within 50 meters
sobek_lm <- gee_terrain %>%
  lm(maxdepth ~ logarea + slope50_max, data=.)

# Heathcote 2015 - mean elevation change within the buffer minus lake elevation
heathcote_df <- gee_terrain %>%
  drop_na() %>%
  # throw out garbage points
  filter(log_elev_change > -5)

heathcote_lm <- heathcote_df %>%
  lm(log_maxdepth ~ log_elev_change, data=.)

# now back-calculate the predicted depth using the bias-correction equation
# they have on p.3
heathcote_residual_variance <- 1 - summary(heathcote_lm)$adj.r.squared

heathcote_df <- heathcote_df %>%
  mutate(., log_predicted = predict(heathcote_lm, .),
         # their given bias prediction equation is way off, 
         # idk what's going on here
         predicted = 10^log_predicted) %>%
  rename(predicted_heathcote = predicted)

# Oliver 2016 - log(maxdepth)
# TODO implement this model - their notation is very confusing and idk what is
# going on

# back calculate everything else
model_compare_df <- gee_terrain %>%
  left_join(heathcote_df %>% select(NLAID, predicted_heathcote),
            by="NLAID") %>%
  mutate(., predicted_sobek = predict(sobek_lm, data=.),
         predicted_hollister = predict(hollister_lm, data=.))
```

```{r model-performance-table}
# calc RMSE for each model type
model_compare_rmse <- model_compare_df %>%
  select(maxdepth, contains("predicted")) %>%
  drop_na() %>%
  summarize(
    rmse_sobek = sqrt(mean((maxdepth - predicted_sobek)^2)),
    rmse_hollister = sqrt(mean((maxdepth - predicted_hollister)^2)),
    rmse_heathcote = sqrt(mean((maxdepth - predicted_heathcote)^2))
  )

tibble(
  "Citation"=c("Hollister et al. (2011)", "Heathcote et al. (2015)", "Sobek (2011)"),
  "RMSE (m)"=c(model_compare_rmse$rmse_hollister, 
               model_compare_rmse$rmse_heathcote, 
               model_compare_rmse$rmse_sobek),
  "$R^2$"=c(summary(hollister_lm)$adj.r.squared,
            summary(heathcote_lm)$adj.r.squared,
            summary(sobek_lm)$adj.r.squared)
) %>%
  knitr::kable(
    caption="Model performance metrics for existing lake depth models when applied to National Lakes Assessment survey data.",
    digits = 2
  )
```

```{r model-compare-plot, fig.cap="Scatterplots of predicted and actual maximum lake depths under the modeling regimes described in Table 1. Dotted lines indicate 1:1 correspondence."}
model_compare_df %>%
  select(maxdepth, contains("predicted")) %>%
  pivot_longer(contains("predicted")) %>%
  mutate(name = recode(
    name,
    "predicted_hollister"="Hollister et al. (2011)",
    "predicted_heathcote"="Heathcote et al. (2015)",
    "predicted_sobek"="Sobek (2011)"
  )) %>%
  ggplot(aes(x=maxdepth, y=value)) + geom_point() +
  geom_abline(intercept=0, slope=1, size=2, linetype="dashed", color="red") +
  facet_wrap(~ name) +
  coord_equal() +
  labs(y="Predicted Depth (m)", x="True Depth (m)")
```

In all three cases tested, the model performs worse on the NLA dataset than on the dataset from the source publication. This is probably due to the wider spatial extend and more varied environmental context of this data.

## Other Terrain Metrics
Slope is not the only descriptor of terrain morphology. We also considered profile curvature, which is the second derivative of elevation in the direction of maximum slope. We add a quadratic term to the basin morphology model,

\begin{align}
\hat{Z} = D \times S_1 + \frac{D^2}{2} \times S_2
\end{align}

where $S_2$ is profile curvature.

```{r fit-quad-model}
hollister_quad_lm <- lm(
  maxdepth ~ linear_term + quad_term, data=gee_hollister
)
```

The most immediate comparison for this model is Hollister et al. The linear and quadratic terms are somewhat correlated ($r = $ `r round(cor(gee_hollister$quad_term, gee_hollister$linear_term), 2)`). The quadratic term alone accounts for roughly 20% of the variance. But, the linear and quadratic terms together only account for `r round(summary(hollister_quad_lm)$adj.r.squared*100)`% of the variance.

```{r quad-fit-plot, fig.cap="Predicted an actual maximum lake depth using Eq. 2. Dashed line indicates 1:1 correspondence."}
gee_hollister %>%
  mutate(., predicted_quad = predict(hollister_quad_lm, data=.)) %>%
  ggplot(aes(x=maxdepth, y=predicted_quad)) + geom_point() +
  geom_abline(slope=1, intercept=0, color="red", linetype="dashed", size=2) +
  labs(x="True Depth (m)", y="Predicted Depth (m)") +
  coord_equal()
```

Other terrain metrics are also candidate predictors. Metrics calculated from a moving window, such as relief and deviation, are complicated by adding another parameter to set the size of the moving window. The choice of parameter determines the scale of topographic feature captured.

## Geologic Context of Lake Basins
The geologic context of lake basins may be related to sedimentation rate and bathymetry. This, in turn, may make geologic context a predictor of lake depth. We tested a dataset of surficial sediments and underlying bedrock. In both cases, predictive power was low ($R^2 < 0.1$). However, co-occurrence analysis revealed a pattern of note in surficial sediments. A probabilistic model[@veechProbabilisticModelAnalysing2013] was applied to identify sediment types that positively co-occurred. 

```{r sediment-network, fig.align="center", out.width="0.8\\linewidth", fig.cap="Co-occurrence network for surficial sediments within 1km of NLA lake polygons. Connected nodes were significantly more likely to apear in the same buffer ($p < 0.05$)."}
knitr::include_graphics(normalizePath("notebooks/img/geo_network.png", winslash="/"))
```

# Future Work
The influence of sedimentation on lake morphology is not well characterized. Our approach of using sediment categories to relate depth to sedimentation processes was unsuccessful. However, we might have more success including sedimentation in a depth model by determining annual stream flow into lakes.

We also have many terrain metrics to include. Extending basin terrain beyond the lake shoreline only accounts for about $\frac{1}{3}$ of the variance. However, the Heathcote et al. model accounts for nearly $\frac{1}{4}$ of the variance with a single covariate. Other terrain metrics uncorrelated with slope may improve model performance.

\newpage
# References